---
title: "Mapping of Bus Route"
author: "Mengyong Lee"
date: "4/7/2020"
output: html_document
---

```{r, echo = TRUE, eval = TRUE, message = FALSE, warning = FALSE}
packages = c('igraph', 'tidygraph', 'ggraph', 'visNetwork', 'lubridate', 'tidyverse', 'ggplot2', 'ggmap', 'leaflet', 'ggiraph', 'sf', 'tmap')

for(p in packages){library
  if(!require(p, character.only = T)){
    install.packages(p)
  }
  library(p, character.only = T)
}
```


```{r, echo = TRUE, eval = TRUE, message = FALSE, warning = FALSE}

#top_bus <- c('51','61','961','66','67','14','30','143','10','147','178','197','154','167','166','174','196','171','2','12','21','170','970','13')

busstops <- read_csv('data/busstops_with_planning_area_XY.csv')
busstops$BusStopCode <- as.character(busstops$BusStopCode)
busstops <- busstops[c('BusStopCode', 'Description', 'RoadName', 'planning_area', 'Latitude', 'Longitude')]

busstops
```

```{r, echo = TRUE, eval = TRUE, message = FALSE, warning = FALSE}
busroute <- read_csv('data/bus_route_overall.csv')
busroute$BusStopCode <- as.character(busroute$BusStopCode)
busroute <- busroute[c('BusStopCode', 'Direction', 'Distance', 'ServiceNo', 'StopSequence')]
 #       %>% dplyr::filter(ServiceNo %in% top_bus)

busroute <- busroute[busroute$BusStopCode %in% as.list(unique(busstops['BusStopCode']))[['BusStopCode']], ] 

busroute
```


```{r, echo = TRUE, eval = TRUE, message = FALSE, warning = FALSE}
busroute_2 <- busroute

busroute_2['StopSequence'] = busroute_2['StopSequence']-1
busroute_2['BusStopCode_dest'] = busroute_2['BusStopCode']
busroute_2 <- busroute_2[c('BusStopCode_dest', 'Direction', 'ServiceNo', 'StopSequence')]

busstops_from_to <- dplyr::inner_join(busroute, busroute_2, by =c('StopSequence', 'ServiceNo', 'Direction'))
busstops_from_to
```

```{r, echo = TRUE, eval = TRUE, message = FALSE, warning = FALSE}
#join the two tables together

busroute_busstop <- dplyr::inner_join(busstops_from_to, busstops, by ='BusStopCode')
#keeps <- c('BusStopCode', 'BusStopCode_dest', 'Direction', 'Distance', 'ServiceNo', 'Latitude', 'Longitude', 'planning_area', 'Description')
keeps <- c('BusStopCode', 'BusStopCode_dest')
busroute_busstop <- busroute_busstop[, keeps, drop = FALSE] %>% 
  rename(from = BusStopCode) %>%
  rename(to = BusStopCode_dest)
  
head(busroute_busstop)
```

```{r, echo = TRUE, eval = TRUE, message = FALSE, warning = FALSE}
busroute_busstop_aggregated <- busroute_busstop %>%
  #group_by(from, to, planning_area) %>%
  group_by(from, to) %>%
  summarise(Weight = n()) %>%
  filter(from!=to) %>%
  filter(Weight > 1) %>%
  filter(from!='Invalid') %>%
  filter(to!='Invalid') %>%
  ungroup()

busroute_busstop_aggregated$from <- as.character(busroute_busstop_aggregated$from)
busroute_busstop_aggregated$to <- as.character(busroute_busstop_aggregated$to)

busroute_busstop_aggregated
```


```{r, echo = TRUE, eval = TRUE, message = FALSE, warning = FALSE}
nodes_my <- busstops %>%
  rename(id = BusStopCode)
nodes_my$id <- as.character(nodes_my$id)

nodes_my

```


```{r, echo = TRUE, eval = TRUE, message = FALSE, warning = FALSE}
bus_graph <- tbl_graph(nodes = nodes_my, edges = busroute_busstop_aggregated, directed = TRUE)
bus_graph
```


```{r, echo = TRUE, eval = TRUE, message = FALSE, warning = FALSE}
bus_graph=bus_graph%>%mutate(betweenness_centrality = centrality_betweenness(normalized = TRUE)) %>%mutate(closeness_centrality = centrality_closeness(normalized = TRUE)) %>%mutate(degree_centrality=centrality_degree(mode='out',normalized = TRUE))%>%mutate(eigen_centrality=centrality_eigen(weights=bus_graph$Weight,directed=TRUE))

bus_graph
```


```{r, echo = TRUE, eval = TRUE, message = FALSE, warning = FALSE, fig.height=20, fig.width=20}
plot_vector2<- as.data.frame(cbind(V(bus_graph)$Longitude,V(bus_graph)$Latitude,V(bus_graph)$betweenness_centrality,V(bus_graph)$closeness_centrality,
                                   V(bus_graph)$eigen_centrality,V(bus_graph)$degree_centrality))

edgelist <- get.edgelist(bus_graph)
edgelist[,1]<-as.numeric(match(edgelist[,1],V(bus_graph)))
edgelist[,2]<-as.numeric(match(edgelist[,2],V(bus_graph)))

node1=data.frame(plot_vector2[edgelist[,1],])
node2=data.frame(plot_vector2[edgelist[,2],])
node3=data.frame(cbind(node1,node2))

edge_table <- node3 %>%
  rename(c(long.f = V1, lat.f = V2, long.t = V1.1, lat.t = V2.1))%>%
  dplyr::left_join(busstops, by =c("long.f"= "Longitude", "lat.f" = "Latitude")) 

keeps <- c("long.f","lat.f","long.t","lat.t", "planning_area")
edge_table <- edge_table[ , (names(edge_table) %in% keeps)]

edge_table

```
```{r, echo = TRUE, eval = TRUE, message = FALSE, warning = FALSE, fig.height=20, fig.width=20}
plot_vector2<- as.data.frame(cbind(V(bus_graph)$Longitude,V(bus_graph)$Latitude,V(bus_graph)$betweenness_centrality,V(bus_graph)$closeness_centrality,
                                   V(bus_graph)$eigen_centrality,V(bus_graph)$degree_centrality))

#node1=data.frame(plot_vector2)

map_table <- plot_vector2 %>%
  rename(c(long.f = V1, lat.f = V2, between.f = V3, closeness.f = V4, eigen.f = V5, degree.f = V6))%>%
  dplyr::left_join(busstops, by =c("long.f"= "Longitude", "lat.f" = "Latitude")) 

range01 <- function(x){(x-min(x))/(max(x)-min(x))}

map_table$between.f <-range01(map_table$between.f)
map_table$closeness.f <-range01(map_table$closeness.f)
map_table$eigen.f <-range01(map_table$eigen.f)
map_table$degree.f <-range01(map_table$degree.f)

map_table$combined.f = log(map_table$between.f+1) + log(map_table$closeness.f+1) + log(map_table$eigen.f+1) + log(map_table$degree.f)

map_table

```



```{r}

#write.csv(map_table ,"bus_graph_view.csv", row.names = FALSE)


```

```{r, echo = TRUE, eval = TRUE, message = FALSE, warning = FALSE, fig.height=20, fig.width=20}

map_table <- map_table %>% dplyr::filter(planning_area == "Ang Mo Kio")
edge_table <- edge_table %>% dplyr::filter(planning_area == "Ang Mo Kio")


map3 = leaflet(map_table) %>%
  addProviderTiles("CartoDB", group = "CartoDB") %>% 
  addTiles() %>%
    setMaxBounds(lng1 = 103.801959 + .25, 
               lat1 = 1.32270 + .25, 
               lng2 = 103.801959 - .25, 
               lat2 = 1.32270 - .25)

for(i in 1:nrow(edge_table)){
    map3 <- addPolylines(map3, lat = as.numeric(edge_table[i, c('lat.f', 'lat.t')]), 
                               lng = as.numeric(edge_table[i, c('long.f', 'long.t')]),
                                #weight = 0.5,
                                color = 'blue'
                         )
}

for(i in 1:nrow(map_table)){
    #origin
    map3<-addCircleMarkers(map3, lat = as.numeric(map_table[i, 'lat.f']), 
                               lng = as.numeric(map_table[i,'long.f']),
                           radius =(as.numeric(map_table[i, 'combined.f'])*25),
                           color='red',
                           fillOpacity = 0.75,
                               label = map_table[i,'id.Description'],
                             popup = ~paste0("<b>", map_table[i,'Description'], "</b>", "<br/>", 'Betweenness Centrality: ', round(map_table[i,'between.f'],3), "<br/>", 'Closeness Centrality: ', round(map_table[i,'closeness.f'],3), "<br/>", 'Eigenvalue Centrality: ', round(map_table[i,'eigen.f'],3), "<br/>", 'Degree Centrality: ', round(map_table[i,'degree.f'],3))
                           )

}
map3

```

